name: Actions Whitelist Request Handler

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write     # Needed for commenting and updating issues
  actions: write    # Needed for managing GitHub Actions settings
  contents: write   # Needed for pushing changes to the repository

jobs:
  process-whitelist-request:
    runs-on: self-hosted
    if: contains(github.event.issue.labels.*.name, 'actions-whitelist-request')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract Action Reference
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            if (!issueBody) {
              throw new Error('Issue body is empty');
            }
            
            // Extract action reference between "### Action Reference" and the next section
            const actionRefMatch = issueBody.match(/### Action Reference\s*([^#]*)/);
            if (!actionRefMatch || !actionRefMatch[1].trim()) {
              throw new Error('Action Reference section not found or empty');
            }
            
            const actionRef = actionRefMatch[1].trim();
            console.log('Extracted Action Reference:', actionRef);
            return actionRef;
          result-encoding: string

      - name: Log Action Reference
        env:
          ACTION_REF: ${{ steps.extract.outputs.result }}
        run: |
          echo "Processing whitelist request for action: ${{ env.ACTION_REF }}"
          
      - name: Update Issue Title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const actionRef = '${{ steps.extract.outputs.result }}'
              if (!actionRef) {
                throw new Error('Action reference is empty or undefined')
              }

              console.log('Current issue details:', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                actionRef: actionRef
              })
              
              const newTitle = `[Action Whitelist Request] ${actionRef}`
              console.log('Attempting to update issue title to:', newTitle)
              
              const result = await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                title: newTitle
              })

              if (result.status !== 200) {
                throw new Error(`Failed to update issue title. Status: ${result.status}`)
              }

              console.log('Issue title updated successfully:', newTitle)
            } catch (error) {
              console.error('Failed to update issue title:', error.message)
              core.setFailed(`Failed to update issue title: ${error.message}`)
            }

      - name: Evaluate Action
        id: evaluate
        uses: ./sentinel
        with:
          action-name: ${{ steps.extract.outputs.result }}
          organization: ${{ github.repository_owner }}
          github-token: ${{ secrets.ACTION_WHITELIST_TOKEN }}

      - name: Add Evaluation Results
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const actionRef = '${{ steps.extract.outputs.result }}';
              const evaluationStatus = '${{ steps.evaluate.outputs.status }}';
              const evaluationDetails = `${{ steps.evaluate.outputs.details }}`.replace(/'/g, "\\'").replace(/\r?\n/g, '\\n');
              
              let evaluationResultObj;
              try {
                evaluationResultObj = JSON.parse('${{ steps.evaluate.outputs.result }}'.replace(/'/g, '"'));
              } catch (e) {
                console.error('Error parsing evaluation results:', e);
                evaluationResultObj = { error: 'Could not parse evaluation results' };
              }
              
              let status, summary, icon;
              if (evaluationStatus === 'success') {
                status = 'Successfully Processed';
                summary = 'The action has been successfully evaluated and processed for whitelisting.';
                icon = '✅';
              } else if (evaluationStatus === 'failure') {
                status = 'Evaluation Failed';
                summary = evaluationResultObj.error || 'The action evaluation encountered issues that need to be addressed.';
                icon = '⚠️';
              } else {
                status = 'Process Incomplete';
                summary = 'The action evaluation process did not complete as expected.';
                icon = '❓';
              }

              const resultDetails = evaluationDetails ? evaluationDetails.replace(/\\n/g, '\n') : 'No additional details available';
              
              const commentBody = [
                `## Action Whitelist Evaluation ${icon}`,
                '',
                `**Status**: ${status}`,
                `**Action**: \`${actionRef}\``,
                '',
                summary,
                '',
                '```json',
                JSON.stringify(evaluationResultObj, null, 2),
                '```',
                '',
                '```',
                resultDetails,
                '```',
                '',
                evaluationStatus === 'success' 
                  ? '_This issue will be closed as the evaluation was successful._'
                  : '_Please address the issues above and update the issue to trigger a new evaluation._',
                '',
                '_Generated by Actions Sentinel_ 🤖'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              
              console.log('Evaluation results comment added successfully');
            } catch (error) {
              console.error('Failed to add evaluation results comment:', error);
              throw error;
            }

      - name: Update Whitelist File
        if: success() && steps.evaluate.outputs.status == 'success'
        run: |
          # Read the current whitelist content
          if [ -f "actions-whitelist.yml" ]; then
            echo "Updating existing whitelist file"
          else
            echo "Creating new whitelist file"
            echo "allowedActions:" > actions-whitelist.yml
          fi
          
          # Add the new action to the whitelist
          echo "  - ${{ steps.extract.outputs.result }}" >> actions-whitelist.yml
          
          # Sort the file to keep it organized (excluding the first line)
          sed '1d' actions-whitelist.yml | sort -u > temp_actions.yml
          echo "allowedActions:" > actions-whitelist.yml
          cat temp_actions.yml >> actions-whitelist.yml
          rm temp_actions.yml

      - name: Commit and Push Changes
        if: success() && steps.evaluate.outputs.status == 'success'
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # Check if there are changes to commit
          if [[ -n "$(git status --porcelain)" ]]; then
            git add actions-whitelist.yml
            git commit -m "chore: Update actions whitelist with ${{ steps.extract.outputs.result }}"
            git push
            echo "Successfully pushed whitelist changes"
          else
            echo "No changes to commit"
          fi

      - name: Close Issue if Successful
        uses: actions/github-script@v7
        if: success() && steps.evaluate.outputs.status == 'success'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });
              console.log('Issue closed successfully');
            } catch (error) {
              console.error('Failed to close issue:', error);
              throw error;
            }
